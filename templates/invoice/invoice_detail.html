{% extends "invoice/base.html" %}
{% load static %}
{% block main_content %}
     <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <div class="container-full">
      <!-- Content Header (Page header) -->	  
      <div class="content-header">
          <div class="d-flex align-items-center">
              <div class="me-auto">
                  <h4 class="page-title">Invoice</h4>
                  <div class="d-inline-block align-items-center">
                      <nav>
                          <ol class="breadcrumb">
                              <li class="breadcrumb-item"><a href="{% url 'invoice' %}"><i class="glyphicon glyphicon-circle-arrow-left"></i></a></li>
                              <li class="breadcrumb-item active" aria-current="page">Go back</li>
                          </ol>
                      </nav>
                  </div>
              </div>
              
          </div>
      </div>  

      <!-- Main content -->
      <section class="invoice printableArea">
        <div class="row">
          
          <div class="col-12">
            <div class="page-header">
              <h2 class="d-inline"><span class="fs-30">Invoice Details</span></h2>
              <div class="pull-right text-end">
                  <h3>{{invoice.created_at}}</h3>
              </div>	
            </div>
          </div>
          <!-- /.col -->
        </div>
        <div class="row invoice-info">
          <div class="col-md-6 invoice-col">
            <strong>From</strong>	
            <address>
              <strong class="text-blue fs-24">{{invoice.customer_name}}</strong><br>
              <strong class="d-inline">Invoice No: {{invoice.invoice_number}}</strong><br> 
            </address>
          </div>
          <div class="col-sm-12 invoice-col mb-15">
              <div class="invoice-details row no-margin">
                <div class="col-md-6 col-lg-3"><b>Date Received: </b>{{invoice.date_received}}</div>
                <div class="col-md-6 col-lg-3"><b>Payment Due: </b>{{invoice.payment_due_date}}</div>
                <div class="col-md-6 col-lg-3"><b>Amount(RWF):</b>{{invoice.amount}}</div>
                <div class="col-md-6 col-lg-3">
                          <b>Status: </b> <span class="badge badge-pill {% if invoice.status == 'Paid' %}badge-success {% elif invoice.status == 'Pending' %}badge-warning
                          {% elif invoice.status == 'Incomplete' %}badge-danger
                          {% else %}badge-secondary{% endif %}">{{invoice.status}}</span> 
                </div>
              </div>
          </div>
        <!-- /.col -->
        </div>
        <div class="row">
          <div class="col-12 table-responsive">
            <table class="table table-bordered">
              <tbody>
              <tr>
                <th>#File</th>
                <th>File Attachment</th>
              </tr>
              {% if invoice.EBM_invoice %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i> EBM Invoice</td>
                </tr>
              {% endif %}
              {% if invoice.CIT_declaration %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>CIT declaration</td>
                </tr>
              {% endif %}
              {% if invoice.good_received_note %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Good Received Note</td>
                </tr>
              {% endif %}
              {% if invoice.delivery_note %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Delivery Note</td>
                </tr>
              {% endif %}
              {% if invoice.purchase_order %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Purchase Order</td>
                </tr>
              {% endif %}
              {% if invoice.profoma %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Profoma</td>
                </tr>
              {% endif %}
              {% if invoice.contract_copy %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Copy of Contract</td>
                </tr>
              {% endif %}
              {% if invoice.final_notification_letter %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Final Notification Letter</td>
                </tr>
              {% endif %}
              {% if invoice.tender_evaluation_report %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Tender Evaluation Report</td>
                </tr>
              {% endif %}
              {% if invoice.perfomance_guaranty %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Perfomance Guaranty</td>
                </tr>
              {% endif %}
              {% if invoice.advance_security %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Advance Security</td>
                </tr>
              {% endif %}
              {% if invoice.tender_advertisement %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Tender Advdertisement</td>
                </tr>
              {% endif %}
              {% if invoice.requisition_form %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Requisition Form</td>
                </tr>
              {% endif %}
              {% if invoice.official_appointment_of_receiving_committee %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Official Appointment of Receiving Committee</td>
                </tr>
              {% endif %}
              {% if invoice.evaluation_report_of_previous_period %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Evaluation Report of Previous Period</td>
                </tr>
              {% endif %}
              {% if invoice.attendance_list %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Attendance List</td>
                </tr>
              {% endif %}
              {% if invoice.officialmission_clearance_signed_at_destination_appointment_of_receiving_committee %}
                <tr>
                  <td>-</td>
                    <td> <i class="glyphicon glyphicon-ok text-success"></i>Mission Clearance Signed at Destination</td>
                </tr>
              {% endif %}
              </tbody>
            </table>
          </div>
          <!-- /.col -->
        </div>
        <div class="row no-print">
          <div class="col-12">
            {% if request.user.user_role == 'invoice_manager' %}
            {% elif request.user.user_role == 'finance_manager' and invoice.status != 'Paid' %}
              <a href="{% url 'invoice_status_update' invoice.pk %}" type="button" class="btn btn-success pull-right"><i class="glyphicon glyphicon-edit"></i> Change Status
            {% else %}
                <a href="{% url 'invoice_status_update' invoice.pk %}" type="button" class="btn btn-success pull-right"><i class="glyphicon glyphicon-edit"></i> Change Status
            {% endif %}
            </a>
          </div>
        </div>
      </section>
      <!-- /.content -->
      <hr>

      <div class="row">
        <div class="col-md-6">
          <h4><i class="glyphicon glyphicon-credit-card"></i> Payment History</h4>
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Date</th>
                <th>Amount Paid</th>
                <th>Paid By</th>
              </tr>
            </thead>
            <tbody>
              {% for payment in payment_history %}
                <tr>
                  <td>{{ payment.paid_at|date:"Y-m-d H:i" }}</td>
                  <td>{{ payment.amount_paid }}</td>
                  <td>{{ payment.paid_by }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="3" class="text-muted">No payments recorded yet.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          <p><b>Total Paid:</b> {{ invoice.total_paid }} / <b>Balance:</b> {{ invoice.remaining_balance }}</p>
        </div>

        <div class="col-md-6">
          <h4><i class="glyphicon glyphicon-time"></i> Status Change History</h4>
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Date</th>
                <th>From → To</th>
                <th>Changed By</th>
                <th>Comment</th>
              </tr>
            </thead>
            <tbody>
              {% for history in status_history %}
                <tr>
                  <td>{{ history.changed_at|date:"Y-m-d H:i" }}</td>
                  <td>{{ history.previous_status }} → {{ history.new_status }}</td>
                  <td>{{ history.changed_by }}</td>
                  <td>
                    {% if history.comment %}
                      <span class="text-danger">{{ history.comment }}</span>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-muted">No status changes yet.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
</div>
<!-- /.content-wrapper -->
{% endblock main_content%}